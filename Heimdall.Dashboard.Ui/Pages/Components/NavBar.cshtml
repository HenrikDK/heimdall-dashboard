<template id="nav-bar">
    <header class="text-base z-10 h-14 sticky top-0 bg-k8s dark:bg-zinc-900">
        <nav>
            <div class="px-2 flex justify-between w-full">
                <div>
                    <router-link :to="{ name: 'cluster' }" class="cursor-pointer">
                        <div class="flex pt-1">
                            <div class="w-16 fill-white dark:fill-k8s" alt="Heimdall">
                                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 501 372">
                                <path d="M 18.41 375.899 C -13.648 275.169 9.337 173.843 63.998 102.773 C 118.659 31.703 205.192 -9.418 299.785 10.054 C 375.317 25.602 435.781 76.897 470.819 144.294 C 505.857 211.692 515.588 295.477 489.978 375.908 L 489.82 376.406 L 489.344 376.408 C 451.932 376.565 414.52 376.685 377.108 376.767 C 383.641 372.539 426.311 342.902 432.134 286.547 C 436.062 248.512 421.278 224.825 414.915 216.573 C 411.087 210.974 404.651 207.3 397.364 207.3 C 385.619 207.3 376.115 216.814 376.115 228.55 C 376.115 240.291 385.618 249.794 397.364 249.794 C 400.057 249.794 402.636 249.292 405.009 248.377 C 410.966 269.714 398.056 288.538 342.812 298.943 C 338.208 295.704 332.594 293.804 326.536 293.804 C 317.738 293.804 309.876 297.811 304.679 304.1 C 296.709 304.846 288.179 305.476 279.058 305.987 C 275.237 300.438 269.489 296.318 262.779 294.592 L 262.779 268.892 C 309.371 270.269 345.916 277.901 346.315 277.976 C 348.317 278.413 350.401 277.934 352.042 276.711 C 353.535 275.589 354.511 273.93 354.782 272.083 C 354.914 271.564 355.341 270.111 355.734 268.824 C 359.046 257.682 367.844 228.106 367.886 194.539 C 367.916 175.331 365.02 157.806 359.305 142.45 C 352.28 123.576 340.919 107.794 325.541 95.52 C 324.285 94.522 322.729 93.972 321.121 93.972 L 262.779 93.972 L 262.779 72.732 C 262.779 68.81 259.611 65.646 255.699 65.646 C 251.787 65.646 248.617 68.81 248.617 72.732 L 248.617 93.972 L 149.459 93.972 C 146.761 93.972 144.302 95.508 143.108 97.925 C 141.915 100.334 142.195 103.218 143.83 105.366 C 166.875 135.498 176.187 171.887 171.512 213.505 C 167.981 244.98 157.328 267.787 157.225 268.016 C 156.048 270.485 156.406 273.431 158.149 275.548 C 159.513 277.209 161.532 278.14 163.62 278.14 C 164.203 278.14 164.784 278.059 165.361 277.914 C 189.517 271.793 217.531 268.682 248.617 268.68 L 248.617 294.592 C 241.446 296.437 235.374 301.019 231.581 307.156 C 223.374 307.067 215.674 306.812 208.45 306.417 C 203.369 298.812 194.705 293.804 184.872 293.804 C 177.26 293.804 170.348 296.805 165.257 301.69 C 130.103 295.519 113.315 285.65 104.774 280.093 C 104.77 280.093 104.764 280.093 104.759 280.093 C 103.489 278.888 101.771 278.12 99.876 278.12 C 95.963 278.12 92.796 281.295 92.796 285.219 C 92.296 304.625 115.16 357.823 134.586 376.769 C 96.071 376.686 57.558 376.562 19.044 376.399 L 18.568 376.397 L 18.41 375.899 Z"></path>
                                </svg>
                            </div>
                            <div class="px-4">
                                <span class="text-5xl text-white dark:text-k8s">Heimdall</span>
                            </div>
                        </div>
                    </router-link>
                </div>
                <div class="flex justify-end items-center">
                    <template v-if="$route.path != '/'">
                        <div class="mr-3 w-60">
                            <multiselect :values="namespaces" @@update:model-value="$emit('select-ns', $event)"></multiselect>
                        </div>
                        <div class="mr-3 w-60">
                            <search @@update:model-value="$emit('search', $event);"></search>
                        </div>
                    </template>
                    <div class="mx-3">
                        <button class="dark:hidden block hs-dark-mode group flex items-center text-gray-300 hover:text-blue-200 font-medium dark:text-gray-100 dark:hover:text-gray-200" 
                                @@click="toggleDark()">
                          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"/>
                          </svg>
                        </button>
                        <button class="dark:block hidden hs-dark-mode group flex items-center text-gray-200 hover:text-blue-600 font-medium dark:text-gray-400 dark:hover:text-gray-500" 
                                @@click="toggleDark()">
                          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                          </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>
</template>

<script type="module">
    import {useDark, useToggle} from "vueuse";
    
    const isDark = useDark()
    const toggleDark = useToggle(isDark);

    components["nav-bar"] = {
      template: "#nav-bar",
      emits: ['search', 'select-ns', 'filters'],
      data() {
        return {
            filters: [],
            cluster: [],
            namespaces: [],
            isDark: isDark,
        }
      },
      methods: {
        toggleDark: toggleDark,
        async updateList() {
          if (!this.cluster && this.cluster.length > 0) return;
                    
          let ns = this.cluster.map(x => { return x.metadata.name})
          
          if (this.filters && this.filters.length > 0){
            ns = ns.filter(x => nsEndsWith(x, this.filters));
            this.$emit('filters', this.namespaces);
          }
          
          ns.sort();
          
          this.namespaces = ns;
        },
        nsEndsWith(ns, ends){
          let value = false;
          value = ends.some(element => {
            return ns.endsWith(element);
          });
          return value;
        }
      },
      watch: {
        filters: function (){this.updateList()},
        cluster: function (){this.updateList()},
      },
      async mounted() {
        fetch("/?handler=filters")
         .then(d => d.json())
         .then(j => this.filters = j);
        
        var host = window.location.origin;
        streamResults(host + '/k8s/api/v1/namespaces', j => this.cluster = j)
      }
    };
</script>
